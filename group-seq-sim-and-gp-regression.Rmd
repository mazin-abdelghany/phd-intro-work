---
title: "Introductory coding examples"
output: html_document
date: "2025-10-17"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# load required libraries
library(ggplot2)
library(mvtnorm)
```

# Introductory coding examples

## Group sequential design simulations

### General RCT planning

The statistical design of the below example trial will assume that a treatment $T$ is being assessed against placebo. The parameter to be estimated, $\theta$, is the difference in a continuous outcome of interest, $O$, between the treatment and placebo groups.

For example, the treatment $T$ may be an anti-hypertensive therapy and the outcome of interest $O$ may be the difference in systolic blood pressure (SBP): $\theta = SBP_{\text{placebo}} - SBP_{\text{treatment}}$. An ineffective therapy would have no effect on the systolic blood pressure. Thus, we have: 

$$
\text{Null hypothesis}, H_0: \theta \le 0 \qquad \text{Alternative hypothesis}, H_1:\theta>0
$$ 

A suitable test statistic, $Z$, would then be utilized to test the above hypothesis at a critical value threshold $c$. The null hypothesis would be rejected if 

$$
Z > c, \text{where } P(Z > c) \le \alpha
$$ 

and the sample size $n$ would be chosen so that 

$$
P(Z > c) \ge 1- \beta \text{ when } \theta = \delta
$$ 

where $\alpha$ is the frequentist type I error rate, $\beta$ is the frequentist type II error rate and $\delta$ is a selected, assumed treatment effect of clinical significance.

### Group sequential design planning

In group sequential designs, a number of analyses, $J$, are performed at pre-selected points with each analysis numbered as $j = 1, 2, \dots, j-1, J$. At each timepoint, a test statistic $Z_j$ would be calculated to assess for stopping of the trial either for futility or efficacy. Upper and lower bounds ($u_j$ and $\ell_j$) for the test statistic would be prespecified for each analysis timepoint, creating a boundary for clinical trial decisions.

```{r}
boundaries <- data.frame(
  x = c(5, 3, 2, 1.5, 1),
  y = c(-2, -1, 0, 0.5, 1),
  j_analysis = c(1, 2, 3, 4, 5)
)

ggplot(data = boundaries) +
  geom_ribbon(mapping = aes(x = j_analysis, ymin = x, ymax = y), color = "grey", alpha = 0.3) +
  geom_line(mapping = aes(x = j_analysis, y = y), color = "red") +
  geom_line(mapping = aes(x = j_analysis, y = x), color = "blue") +
  geom_point(mapping = aes(x = j_analysis, y = y)) +
  geom_point(mapping = aes(x = j_analysis, y = x)) +
  annotate("label", x = 2, y = 1, label = "Continue trial") +
  annotate("label", x = 3, y = 4, label = "Stop for efficacy (reject null)") +
  annotate("label", x = 3, y = -1.5, label = "Stop for futility (fail to reject null)") +
  ylab("Test statistic, Z") +
  xlab("Analysis number, j") +
  scale_x_continuous(limits = c(0.5,5.3), breaks = c(1, 2, 3, 4, 5)) +
  scale_y_continuous(limits = c(-3, 6))
```

### Bootstrap sample size calculations

Continuing with the above example of treatment of hypertension with two groups, we can consider the sample size of a hypothetical trial. First, we perform the bootstrapping under the null hypothesis of $\theta = 0$.

Generating data for groups without difference in mean, first stage:
```{r}
list_of_pbo <- list()
list_of_trt <- list()

t_test_df <- data.frame(
  t_test = c(rep(0, 1000)),
  p_val = c(rep(0, 1000))
) 

# get 1000 sample mean differences
for (i in 1:1000) {
  # generate placebo group data
  pbo <- rnorm(10, mean = 140, sd = 10)
  list_of_pbo[[i]] <- pbo
  
  # generate treatment group data
  trt <- rnorm(10, mean = 140, sd = 10)
  list_of_trt[[i]] <- trt
  
  # get the test statistic for difference between means
  t_test <- t.test(pbo, trt, "greater")
  t_test_df$t_test[i] <- t_test$statistic
  t_test_df$p_val[i] <- t_test$p.value
}

par(mfrow = c(1,2))
hist(t_test_df$t_test)
hist(t_test_df$p_val)
```

Generating data for groups without difference in mean, second stage:
```{r}
t_test_df <- data.frame(
  t_test = c(rep(0, 1000)),
  p_val = c(rep(0, 1000))
) 

# get 1000 sample mean differences
for (i in 1:1000) {
  # generate placebo group data
  pbo <- rnorm(10, mean = 140, sd = 10)
  list_of_pbo[[i]] <- c(list_of_pbo[[i]], pbo)
  
  # generate treatment group data
  trt <- rnorm(10, mean = 140, sd = 10)
  list_of_trt[[i]] <- c(list_of_trt[[i]], pbo)
  
  # get the test statistic for difference between means
  t_test <- t.test(list_of_pbo[[i]], list_of_trt[[i]], "greater")
  t_test_df$t_test[i] <- t_test$statistic
  t_test_df$p_val[i] <- t_test$p.value
}

par(mfrow = c(1,2))
hist(t_test_df$t_test)
hist(t_test_df$p_val)
```

Generating data for groups without difference in mean, third stage:
```{r}
t_test_df <- data.frame(
  t_test = c(rep(0, 1000)),
  p_val = c(rep(0, 1000))
) 

# get 1000 sample mean differences
for (i in 1:1000) {
  # generate placebo group data
  pbo <- rnorm(10, mean = 140, sd = 10)
  list_of_pbo[[i]] <- c(list_of_pbo[[i]], pbo)
  
  # generate treatment group data
  trt <- rnorm(10, mean = 140, sd = 10)
  list_of_trt[[i]] <- c(list_of_trt[[i]], pbo)
  
  # get the test statistic for difference between means
  t_test <- t.test(list_of_pbo[[i]], list_of_trt[[i]], "greater")
  t_test_df$t_test[i] <- t_test$statistic
  t_test_df$p_val[i] <- t_test$p.value
}

par(mfrow = c(1,2))
hist(t_test_df$t_test)
hist(t_test_df$p_val)
```

### Questions for meeting
1. Why format $\mathbf{u}$ and $\mathbf{\ell}$ as ${cu_1, \dots, cu_2}$?
2. Slide 16/43, $c$ is not mentioned?
3. Same slide, are $\mathbf{u}$, $\mathbf{\ell}$, $\mathbf{n}$, $\delta$ chosen randomly?
4. The above is incorrect because these are considered multivariate normals with dependence.
5. Why $u_2$ to infinity rather than $l_2$ to infinity?

### Multivariate normal probability test calculations
First, we set up the variables needed for each of the calculations:
```{r}
n1 <- 20
n2 <- 40
n3 <- 60

theta_0 <- 0  # theta under the null
delta <- 0.5  # theta under the alternative

sigma <- 1 # assumed known

# bounds of integration
u1 <- 2.5
u2 <- 2
u3 <- Inf
l1 <- 0
l2 <- 0.75
l3 <- 1.5
```


The following equation is used to calculate the probability of stopping at Analysis 1 in the example on Slide 16. For the  first analysis, this is a single variable normal distribution. The probability of stopping for futility **under the null** is the lower tail of the normal distribution up to the first lower bound (the selected critical value, $z$).

$$
\int_{-\infty}^{l_1} \phi_2 \left( \begin{bmatrix}
    y_1 
\end{bmatrix}, \begin{bmatrix} 
\theta \sqrt{\frac{n_1}{2\sigma^2}} 
\end{bmatrix}, \begin{bmatrix} 1 \end{bmatrix} \right)dy_1 
$$

```{r}
mean_0 <- theta_0 * sqrt(n1/(2*sigma))
sigma <- 1

# prob stop for futility
pnorm(l1, mean = mean_0, sd = sigma)
```

The probability of stopping for efficacy **under the null** is the upper tail of the normal distribution from the first upper bound.

$$
\int_{u_1}^{\infty} \phi_2 \left( \begin{bmatrix}
    y_1 
\end{bmatrix}, \begin{bmatrix} 
\theta \sqrt{\frac{n_1}{2\sigma^2}} 
\end{bmatrix}, \begin{bmatrix} 1 \end{bmatrix} \right)dy_1 
$$

```{r}
# prob stop for efficacy
pnorm(u1, mean = mean_0, sd = sigma, lower.tail = FALSE)
```

The probability of stopping for futility **under the alternative** is the lower tail of the normal distribution up to the first lower bound.

$$
\int_{-\infty}^{l_1} \phi_2 \left( \begin{bmatrix}
    y_1 
\end{bmatrix}, \begin{bmatrix} 
\delta \sqrt{\frac{n_1}{2\sigma^2}} 
\end{bmatrix}, \begin{bmatrix} 1 \end{bmatrix} \right)dy_1 
$$

```{r}
mean_1 <- delta * sqrt(n1/(2*sigma))

# prob stop for futility, theta = 0.5
pnorm(l1, mean = mean_1, sd = sigma)
```

The probability of stopping for efficacy **under the alternative** is the upper tail of the normal distribution from the first upper bound.

$$
\int_{u_1}^{\infty} \phi_2 \left( \begin{bmatrix}
    y_1 
\end{bmatrix}, \begin{bmatrix} 
\theta \sqrt{\frac{n_1}{2\sigma^2}} 
\end{bmatrix}, \begin{bmatrix} 1 \end{bmatrix} \right)dy_1 
$$

```{r}
# again,
mean_1 <- delta * sqrt(n1/(2*sigma))

# prob stop for efficacy
pnorm(u1, mean = mean_1, sd = sigma, lower.tail = FALSE)
```

The following equation is used to calculate the probability of stopping for futility **under the null** at Analysis 2 in the example on Slide 16:

$$
\int_{l_1}^{u_1}\int_{-\infty}^{l_2} \phi_2 \left( \begin{bmatrix}
    y_1 & y_2
\end{bmatrix}, \begin{bmatrix} 
\theta \sqrt{\frac{n_1}{2\sigma^2}} & \theta \sqrt{\frac{n_2}{2\sigma^2}} 
\end{bmatrix}, \begin{bmatrix} 1 & \sqrt{\frac{n_1}{n_2}} \\ \sqrt{\frac{n_1}{n_2}} & 1 \end{bmatrix} \right) dy_2\,dy_1 
$$

Recall, $\theta = 0$:
```{r}
mean_0 <- c(theta_0 * sqrt(n1/ (2*sigma) ),
            theta_0 * sqrt(n2/ (2*sigma) ))

SIGMA <- matrix(
  c(1, sqrt(n1/n2),
    sqrt(n1/n2), 1),
  nrow = 2
)

# order of integration doesn't matter here
lower <- c(l1, -Inf)
upper <- c(u1, l2)

# lower <- c(-Inf, l1)
# upper <- c(l2, u1)

pmvnorm(lower = lower, upper = upper, mean = mean_0, corr = SIGMA)
```

When $\theta = \delta = 0.5$:
```{r}
mean_1 <- c(delta * sqrt(n1/ (2*sigma) ),
            delta * sqrt(n2/ (2*sigma) ))

SIGMA <- matrix(
  c(1, sqrt(n1/n2),
    sqrt(n1/n2), 1),
  nrow = 2
)

# order of integration matters here
lower <- c(l1, -Inf)
upper <- c(u1, l2)

# lower <- c(-Inf, l1)
# upper <- c(l2, u1)

pmvnorm(lower = lower, upper = upper, mean = mean_1, corr = SIGMA)
```


The following equation is used to calculate the probability of stopping for efficacy **under the null** at Analysis 2 in the example on Slide 16:

$$
\int_{l_1}^{u_1}\int_{u_2}^{\infty} \phi_2 \left( \begin{bmatrix}
    y_1 & y_2
\end{bmatrix}, \begin{bmatrix} 
\theta \sqrt{\frac{n_1}{2\sigma^2}} & \theta \sqrt{\frac{n_2}{2\sigma^2}} 
\end{bmatrix}, \begin{bmatrix} 1 & \sqrt{\frac{n_1}{n_2}} \\ \sqrt{\frac{n_1}{n_2}} & 1 \end{bmatrix} \right) dy_2\,dy_1 
$$

Recall, $\theta = 0$:
```{r}
mean_0 <- c(theta_0 * sqrt(n1/ (2*sigma) ),
            theta_0 * sqrt(n2/ (2*sigma) ))

SIGMA <- matrix(
  c(1, sqrt(n1/n2),
    sqrt(n1/n2), 1),
  nrow = 2
)

lower <- c(l1, u2)
upper <- c(u1, Inf)

pmvnorm(lower = lower, upper = upper, mean = mean_0, corr = SIGMA)
```

Under the alternative when $\theta = \delta = 0.5$:
```{r}
mean_0 <- c(delta * sqrt(n1/ (2*sigma) ),
            delta * sqrt(n2/ (2*sigma) ))

SIGMA <- matrix(
  c(1, sqrt(n1/n2),
    sqrt(n1/n2), 1),
  nrow = 2
)

lower <- c(l1, u2)
upper <- c(u1, Inf)

pmvnorm(lower = lower, upper = upper, mean = mean_0, corr = SIGMA)
```


The following equation is used to calculate the probability of stopping for efficacy **under the null** at Analysis 3 in the example on Slide 16:

$$
\int_{l_1}^{u_1}\int_{l_2}^{u_2}\int_{l_3}^{\infty} \phi_2 \left( 
\begin{bmatrix}
    y_1 & y_2 & y_3
\end{bmatrix}, 
\begin{bmatrix} 
\theta \sqrt{\frac{n_1}{2\sigma^2}} & \theta \sqrt{\frac{n_2}{2\sigma^2}} & \theta \sqrt{\frac{n_3}{2\sigma^2}} 
\end{bmatrix}, 
\begin{bmatrix} 
1 & \sqrt{\frac{n_1}{n_2}} & \sqrt{\frac{n_1}{n_3}}\\ 
\sqrt{\frac{n_1}{n_2}} & 1 & \sqrt{\frac{n_2}{n_3}}\\
\sqrt{\frac{n_1}{n_3}} & \sqrt{\frac{n_2}{n_3}} & 1
\end{bmatrix} 
\right) dy_3\,dy_2\,dy_1
$$

For $\theta = 0$:
```{r}
mean_0 <- c(theta_0 * sqrt(n1/ (2*sigma) ),
            theta_0 * sqrt(n2/ (2*sigma) ),
            theta_0 * sqrt(n3/ (2*sigma) ))

SIGMA <- matrix(
  c(1, sqrt(n1/n2), sqrt(n1/n3),
    sqrt(n1/n2), 1, sqrt(n2/n3),
    sqrt(n1/n3), sqrt(n2/n3), 1),
  nrow = 3
)

lower <- c(l1, l2, l3)
upper <- c(u1, u2, Inf)

pmvnorm(lower = lower, upper = upper, mean = mean_0, corr = SIGMA)
```

Under the alternative when $\theta = \delta = 0.5$:
```{r}
mean_1 <- c(delta * sqrt(n1/ (2*sigma) ),
            delta * sqrt(n2/ (2*sigma) ),
            delta * sqrt(n3/ (2*sigma) ))

SIGMA <- matrix(
  c(1, sqrt(n1/n2), sqrt(n1/n3),
    sqrt(n1/n2), 1, sqrt(n2/n3),
    sqrt(n1/n3), sqrt(n2/n3), 1),
  nrow = 3
)


lower <- c(l1, l2, l3)
upper <- c(u1, u2, Inf)

pmvnorm(lower = lower, upper = upper, mean = mean_1, corr = SIGMA)
```


The following equation is used to calculate the probability of stopping for futility **under the null** at Analysis 3 in the example on Slide 16:

$$
\int_{l_1}^{u_1}\int_{l_2}^{u_2}\int_{-\infty}^{l_3} \phi_2 \left( 
\begin{bmatrix}
    y_1 & y_2 & y_3
\end{bmatrix}, 
\begin{bmatrix} 
\theta \sqrt{\frac{n_1}{2\sigma^2}} & \theta \sqrt{\frac{n_2}{2\sigma^2}} & \theta \sqrt{\frac{n_3}{2\sigma^2}} 
\end{bmatrix}, 
\begin{bmatrix} 
1 & \sqrt{\frac{n_1}{n_2}} & \sqrt{\frac{n_1}{n_3}}\\ 
\sqrt{\frac{n_1}{n_2}} & 1 & \sqrt{\frac{n_2}{n_3}}\\
\sqrt{\frac{n_1}{n_3}} & \sqrt{\frac{n_2}{n_3}} & 1
\end{bmatrix} 
\right) dy_3\,dy_2\,dy_1
$$

Recall, $\theta = 0$:
```{r}
mean_0 <- c(theta_0 * sqrt(n1/ (2*sigma) ),
            theta_0 * sqrt(n2/ (2*sigma) ),
            theta_0 * sqrt(n3/ (2*sigma) ))

SIGMA <- matrix(
  c(1, sqrt(n1/n2), sqrt(n1/n3),
    sqrt(n1/n2), 1, sqrt(n2/n3),
    sqrt(n1/n3), sqrt(n2/n3), 1),
  nrow = 3
)

lower <- c(l1, l2, -Inf)
upper <- c(u1, u2, l3)

pmvnorm(lower = lower, upper = upper, mean = mean_0, corr = SIGMA)
```

And **under the alternative**, when $\theta = \delta = 0.5$:
```{r}
mean_1 <- c(delta * sqrt(n1/ (2*sigma) ),
            delta * sqrt(n2/ (2*sigma) ),
            delta * sqrt(n3/ (2*sigma) ))

SIGMA <- matrix(
  c(1, sqrt(n1/n2), sqrt(n1/n3),
    sqrt(n1/n2), 1, sqrt(n2/n3),
    sqrt(n1/n3), sqrt(n2/n3), 1),
  nrow = 3
)

lower <- c(l1, l2, -Inf)
upper <- c(u1, u2, l3)

pmvnorm(lower = lower, upper = upper, mean = mean_1, corr = SIGMA)
```

## Gaussian process regression










